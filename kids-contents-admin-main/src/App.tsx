import { NavLink, Routes, Route, Navigate, Outlet } from "react-router-dom";
import Dashboard from "./features/dashboard/Dashboard";
import EntityList from "./features/common/EntityList";
import { entityConfigs } from "./features/common/entityConfigs";
import Login from "./features/auth/Login";
import ProtectedRoute from "./features/auth/ProtectedRoute";
import RequireAdmin from "./features/auth/RequireAdmin";
import UserManagement from "./features/users/UserManagement";
import { useAuth } from "./features/auth/AuthContext";

export default function App() {
  return (
    <Routes>
      <Route path="/login" element={<Login />} />
      <Route element={<ProtectedRoute />}>
        <Route element={<AppLayout />}>
          <Route path="/" element={<Dashboard />} />
          <Route
            path="/news"
            element={<EntityList key="news" config={entityConfigs.news} />}
          />
          <Route
            path="/international-news"
            element={
              <EntityList
                key="international_news"
                config={entityConfigs.international_news}
              />
            }
          />
          <Route
            path="/projects"
            element={
              <EntityList key="projects" config={entityConfigs.projects} />
            }
          />
          <Route
            path="/contests"
            element={
              <EntityList key="contests" config={entityConfigs.contests} />
            }
          />
          <Route
            path="/announcements"
            element={
              <EntityList
                key="announcements"
                config={entityConfigs.announcements}
              />
            }
          />
          <Route
            path="/analytics"
            element={
              <EntityList key="analytics" config={entityConfigs.analytics} />
            }
          />
          <Route
            path="/users"
            element={
              <RequireAdmin>
                <UserManagement />
              </RequireAdmin>
            }
          />
          <Route path="*" element={<Navigate to="/" replace />} />
        </Route>
      </Route>
      <Route path="*" element={<Navigate to="/" replace />} />
    </Routes>
  );
}

function AppLayout() {
  const { user, role, signOut } = useAuth();

  return (
    <div className="layout">
      <aside className="sidebar">
        <div className="brand">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fillRule="evenodd"
              clipRule="evenodd"
              d="M7.8207 2.75618C8.52415 2.92579 8.6069 3.39223 8.40001 4.02827C7.77932 3.81625 7.73794 3.56184 7.8207 2.75618ZM16.3862 14.1201L15.6414 14.0353C15.5586 13.6537 15.5172 13.5265 15.6 13.1873C15.8897 13.2297 15.6414 13.0601 16.0552 13.5689C16.2207 13.8233 16.2621 13.8657 16.3862 14.1201ZM6.08276 10.7279C6.86897 10.7279 6.49656 10.7279 6.74484 10.6007L6.82759 11.4064C6.74483 11.4488 6.66208 11.4912 6.53794 11.4488C6.57932 11.364 6.57931 11.4064 6.62069 11.2792C6.49655 11.1943 6.16552 10.8975 6.08276 10.7279ZM11.9172 0C9.84828 0 7.90345 0.551237 6.2069 1.4841C6.2069 1.73852 6.2069 2.03534 6.24828 2.33216C7.53104 1.61131 7.48967 0.93287 9.26898 1.3993L8.77242 1.65371C8.64828 1.69611 8.56552 1.73852 8.35863 1.78092C7.53104 2.12015 6.99311 3.01061 6.12415 3.68905C6.16553 4.66432 6.66207 8.56537 6.70345 9.15901C7.03449 9.20141 7.28276 9.54064 7.07586 9.83746C6.95173 10.0495 7.03449 9.96467 7.11725 10.0919C7.03449 10.3463 6.82759 10.3039 6.82759 10.6007C6.82759 10.7703 6.86897 11.1519 6.91035 11.3216C7.11725 11.2792 7.07587 11.1519 7.32414 11.1519V11.4912C9.43449 11.4488 8.77242 11.1519 9.0207 10.5583C9.22759 10.5583 9.18621 10.5583 9.31035 10.7703C9.51724 11.1943 9.39311 11.1519 9.55862 11.364C9.64138 11.4912 9.68277 11.5336 9.64139 11.7032C9.47587 11.7456 9.39311 11.8728 9.18621 11.8304C8.97932 11.788 8.85517 11.8304 8.68966 11.9152C7.94483 12.1696 8.4 12.0848 7.65517 12.1272C7.69655 12.3392 8.31725 12.6784 8.56552 12.8057C8.8138 12.9329 9.06207 12.7208 9.39311 12.5088C9.76552 12.2544 9.76552 12.636 9.60001 12.8905C9.51725 13.0177 9.47586 13.1025 9.35173 13.2297C9.18621 13.3993 9.26897 13.4417 9.14483 13.5689C9.06207 13.6537 8.93794 13.7385 8.8138 13.6113C8.6069 13.4841 8.6069 13.3569 8.15173 13.1873C7.4069 12.9329 7.73794 12.8057 7.40691 12.9753C7.44829 13.1449 7.48966 13.1025 7.53104 13.2297C7.32414 13.3569 6.24828 14.0777 6.04138 14.0777C6 13.9929 5.95863 13.7809 5.91725 13.6961C5.54484 13.6961 5.13104 13.9081 4.67587 13.8657C4.67587 13.6961 4.84138 13.6113 4.96552 13.1873L5.08966 12.3816C4.75863 12.3816 4.84138 12.5512 4.75862 12.0848C4.71724 11.9152 4.67587 11.6608 4.67587 11.4912C4.67587 11.2792 4.67587 11.0247 4.67587 10.7703C4.67587 10.5583 4.67586 10.6855 4.59311 10.5159C4.51035 10.4311 4.59311 10.4311 4.59311 10.3463C4.0138 10.3463 3.93104 10.6007 3.26898 10.3039C2.68967 10.0495 2.68966 9.87986 2.48276 9.54063C2.27586 9.54063 2.15173 9.66784 2.19311 9.92226C2.44139 10.0919 2.64828 10.0495 2.73104 10.4311C2.8138 10.7279 2.73103 11.1095 2.48276 11.1943C2.48276 11.1943 2.48276 11.1944 2.48276 11.1519C2.44138 10.9823 2.48277 10.9823 2.44139 10.8551C2.35863 11.0247 2.27586 11.2367 1.90345 11.1943C1.53104 11.1519 2.27587 11.0671 1.73794 10.7703C1.36552 10.5583 1.32414 9.96466 1.53104 9.54063C1.69656 9.20141 1.86207 9.15901 2.27586 9.11661C2.1931 9.0318 2.15173 9.0318 2.0276 8.947C1.90346 8.9046 1.82069 8.9046 1.73794 8.81979C1.86207 8.77739 2.02759 8.90459 2.19311 8.90459C2.11035 8.56537 2.23449 8.52297 2.44139 8.77739C2.52415 8.60778 2.52415 8.39577 2.64829 8.18375C2.77242 7.88693 3.10345 7.50531 3.39311 7.3357C3.51725 7.29329 3.47587 7.33569 3.64139 7.25089L3.93103 7.12368L3.0207 4.57951C2.8138 4.57951 2.64828 4.6219 2.52414 4.6219C0.951727 6.69964 0 9.32863 0 12.1696C0 13.3145 0.16552 14.4594 0.455175 15.5194L0.496557 15.6466C0.537936 15.8587 0.620695 16.0707 0.703453 16.2827C1.77932 16.1555 3.43449 14.0353 4.30346 14.841C5.13104 15.5618 4.46897 16.5371 6.28966 16.3251C5.50345 16.1131 5.08966 16.2403 4.96552 15.3074L6.45518 15.3922H8.23449C8.23449 15.0106 8.27586 14.8834 8.27586 14.5866V14.0777C8.27586 14.0777 8.27586 14.0353 8.27586 13.9929C8.27586 13.9929 8.27586 13.9505 8.31724 13.9081L8.52414 14.2049L8.73104 14.629L9.64139 14.0777C9.35173 14.4594 9.35172 14.7986 9.51724 14.9682V14.9258L9.64139 15.0954C9.68277 15.1378 9.76552 15.1802 9.8069 15.1802C10.3035 15.0106 11.5035 14.9682 12.0414 14.9258L14.5241 14.7138C14.731 14.3322 14.6069 14.3746 14.5241 13.9081C14.2759 12.5088 15.1862 11.9152 15.1862 11.2792C14.4828 10.5159 13.3655 11.364 13.8621 9.32862C14.1517 8.18374 15.4345 7.92933 16.1793 8.65017C16.1793 8.77738 16.0138 8.81978 16.1793 9.0742C16.3035 9.24381 16.4276 9.20141 16.6345 9.28622C17.0483 11.2791 16.2621 9.92227 16.0552 10.9399C16.0138 11.2368 15.8897 11.7032 15.931 12C16.0138 12.5088 16.5517 13.6537 16.8414 13.7809C17.0897 13.9081 17.4207 13.9081 17.5035 14.3322C17.6276 14.7986 16.8828 16.4523 17.2138 16.6643C17.5448 16.8763 17.4207 16.5371 17.669 16.8763C17.669 16.8763 17.6276 16.8763 17.6276 16.9187C17.5862 17.0459 17.2552 16.9187 17.1724 16.9187C16.9655 16.8339 16.8414 16.7491 16.7173 16.6219C16.8 16.2403 16.9241 15.0954 16.8414 14.6714C16.6759 14.629 16.6345 14.5866 16.3862 14.629C16.3035 14.8834 16.2207 15.053 16.0966 15.1802C16.2207 15.3074 16.3035 15.477 16.4276 15.6466C16.4276 16.1555 16.8 16.8763 16.8 17.5972C16.8 18.4876 15.6414 22.2615 15.3517 23.0247C15.1862 23.4064 15.0207 23.7032 14.8138 24C20.1104 22.6855 24 17.8092 24 12.0424C23.9172 5.51236 18.5379 0 11.9172 0ZM3.0207 4.70672C3.18621 4.70672 3.39311 4.66431 3.64139 4.66431C4.71725 4.5795 5.46207 4.19789 6 3.73146L6.04138 4.07067C6.04138 4.36749 6.28966 6.44524 6.33104 6.91167C6.33104 7.12368 6.6207 9.28622 6.57932 9.37103C6.53794 9.54064 6.49656 9.24381 6.57932 9.71024C6.33104 9.79505 6.49656 9.96467 6.08276 9.83746C6.00001 9.79506 5.87586 9.75265 5.83449 9.75265C5.71035 9.75265 5.66897 9.75265 5.50346 9.75265C5.50346 9.32862 5.95862 9.37103 5.83449 8.9894C5.79311 8.9046 5.75173 8.8622 5.75173 8.81979C5.71036 8.73499 5.75173 8.65018 5.66897 8.56538C5.58621 8.43817 5.58621 8.56537 5.50346 8.43816C5.46208 8.39576 5.46207 8.31095 5.42069 8.22614C5.33793 8.22614 5.2138 8.22614 5.13104 8.22614C5.08967 8.22614 5.08966 8.18375 5.04828 8.18375C4.96552 8.09895 5.08966 8.22615 5.0069 8.14135L4.96552 8.09894C4.75862 7.84452 4.67587 7.5477 4.42759 7.42049C4.26207 7.33569 4.13793 7.29329 3.93103 7.29329L3.0207 4.70672ZM3.72414 3.30743C3.8069 3.22262 3.93104 3.13781 4.0138 3.05301C4.0138 3.13781 4.05518 3.22262 4.05518 3.30743H3.72414ZM4.51036 2.58657C4.75863 2.41696 5.0069 2.20495 5.25518 2.03534C5.2138 2.50177 5.2138 2.54417 4.88277 2.79859C4.71725 2.75619 4.59311 2.67138 4.51036 2.58657ZM8.27586 2.37456C8.6069 3.18021 9.22759 3.34982 10.2621 3.18021C10.2621 2.20495 8.97931 1.82332 8.27586 2.37456Z"
              fill="url(#paint0_linear_1165_195)"
            />
            <defs>
              <linearGradient
                id="paint0_linear_1165_195"
                x1="7.32761"
                y1="4.75514"
                x2="17.0972"
                y2="19.471"
                gradientUnits="userSpaceOnUse"
              >
                <stop stopColor="#00366E" />
                <stop offset="0.5" stopColor="#005392" />
                <stop offset="1" stopColor="#00366E" />
              </linearGradient>
            </defs>
          </svg>

          <h3>Admin Panel</h3>
        </div>

        <nav className="nav">
          <NavLink to="/" end>
            Bosh sahifa
          </NavLink>
          <NavLink to="/news">Yangiliklar</NavLink>
          <NavLink to="/international-news">Xalqaro Yangiliklar</NavLink>
          <NavLink to="/projects">Loyihalar</NavLink>
          <NavLink to="/contests">Ijodiy tanlovlar</NavLink>
          <NavLink to="/announcements">E'lonlar</NavLink>
          <NavLink to="/analytics">Tahlillar</NavLink>
          {role === "admin" && <NavLink to="/users">Foydalanuvchilar</NavLink>}
        </nav>

        <div className="sidebar-note" style={{ display: "grid", gap: 8 }}>
          <div>
            <div style={{ fontWeight: 600 }}>{user?.email}</div>
            <div className="muted">Rol: {role ?? "belgilanmagan"}</div>
          </div>
          <button className="btn" type="button" onClick={signOut}>
            Chiqish
          </button>
        </div>
      </aside>

      <main className="container">
        <Outlet />
      </main>
    </div>
  );
}
